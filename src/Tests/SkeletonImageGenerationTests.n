using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using Tests.Macros;
using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;

using Tao;
using Tao.Interfaces;

namespace Tests
{
    public class SkeletonImageGenerationTests
    {
        public ShouldHaveDosHeader() : void
        {   
            def originalImageLocation = @"..\..\SampleBinaries\Skeleton.exe";
            def originalBytes = MemoryStream(File.ReadAllBytes(originalImageLocation));
            // TODO: Generate the DOS header using the image
            // TODO: Get the end position of the header and compare all the bytes up to that point
            // TODO: The two headers must match
            // TODO: Use the composite pattern to incrementally build the image
            
            def outputStream = MemoryStream();
            def tracerStream = TracerStream(originalBytes, outputStream);
            
            def header = DosHeader();
            header.LfaNew = 0x80;
            
            def builder = ImageBuilder();
            builder.DOSHeader = header;            
            builder.CreateImage(tracerStream);
            
            // Compare the resulting streams
            def dosHeaderLength : uint = 0x3C;
            outputStream.ShouldMatch(tracerStream, dosHeaderLength);
        }                        
    }
}
