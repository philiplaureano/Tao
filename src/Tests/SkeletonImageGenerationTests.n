using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using Tests.Macros;
using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;

using Tao;
using Tao.Interfaces;

namespace Tests
{
    public class SkeletonImageGenerationTests
    {
        public ShouldHaveDosHeader() : void
        {   
            def originalImageLocation = @"..\..\SampleBinaries\Skeleton.exe";
            def originalBytes = MemoryStream(File.ReadAllBytes(originalImageLocation));           
            
            def outputStream = MemoryStream();
            def tracerStream = TracerStream(originalBytes, outputStream);
            
            def header = DosHeader();
            header.LfaNew = 0x80;
            
            def builder = ImageBuilder();            
            def image = builder.CreateImage();
            
            def writer = ImageWriter(array[DosHeaderWriter()]);
            writer.Write(image, tracerStream);
            
            // Compare the resulting streams
            def dosHeaderLength : uint = 0x3C;
            outputStream.ShouldMatch(tracerStream, dosHeaderLength);
        }                        
    }
}
